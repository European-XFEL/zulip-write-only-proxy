{% extends 'base.html' %}

{% block content %}
<div hx-ext="client-side-templates" class="flex-body">
<form
  id="formCreate"
  class="flex flex-col gap-4 md:gap-6"
  hx-disabled-elt="this"
  hx-post="/create_client"
  hx-target-error="#response"
  hx-indicator="#spinner"
  hx-target="#response"
  hx-swap="innerHTML"
  mustache-template="foo"
>
  <div>
    {% for name, field in required.items() %}
    <span class="label label-text"> {{ field['title'] }}:</span>
    <input
      type="{{ field['type'] }}"
      name="{{ name }}"
      class="input input-bordered w-full"
    />
    {% endfor %}
  </div>
  <div class="collapse bg-base-200 collapse-arrow">
    <input type="checkbox" />
    <div class="collapse-title">Manually configure</div>
    <div class="collapse-content">
      {% for name, field in optional.items() %}
      <div>
        <span class="label label-text">{{ field['title'] }}:</span>
        <input type="text" name="{{ name }}" {% if field['default'] %}
        placeholder="{{ field['default'] }}" {% endif %} class="input
        input-bordered w-full" />
      </div>
      {% endfor %}
    </div>
  </div>
  <button class="btn" id="submitBtn">
    <div id="spinner" class="loading loading-spinner htmx-indicator"></div>
    Submit
  </button>
</form>

<div id="response"></div>
</div>

<template id="foo">
{% raw %}
{{#detail}}
<div role="alert" class="alert alert-error">
  <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
  <span>Error - {{detail}}</span>
</div>
{{/detail}}
{{^detail}}
<div role="alert" class="alert">
  <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
  <span>Bot created: <button class="btn btn-outline" onclick="copyToClipboard(this)">{{key}}</button> </span>
</div>
{{/detail}}
{% endraw %}
</template>

<script>
  addEventListener("htmx:configRequest", (event) => {
    if (event.target.id == "formCreate") {
      event.detail.useUrlParams = true;
      Object.keys(event.detail.parameters).forEach(
        (key) =>
          event.detail.parameters[key] == "" &&
          delete event.detail.parameters[key]
      );
    }
  });

  function copyToClipboard(element) {
    key = element.innerText
    navigator.clipboard.writeText(key).then(() => {
      element.classList.add("btn-success");
      setTimeout(() => {
        element.classList.remove("btn-success");
      }, 2000);
    })
  }
</script>
{% endblock %}
